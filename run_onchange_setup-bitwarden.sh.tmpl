#!/usr/bin/env bash
# Set up Bitwarden CLI configuration and session in macOS Keychain
# This runs only when the chezmoi state changes (run_onchange)

set -euo pipefail

BW_SERVER="https://aifa.dedyn.io"

echo "=== Bitwarden CLI Setup ==="
echo ""

# Check if bw command is available
if ! command -v bw &>/dev/null; then
  echo "âš ï¸  Bitwarden CLI (bw) not found in PATH"
  echo "   Will be installed via: npm install -g @bitwarden/cli"
  echo "   (Make sure mise has Node.js activated)"
  exit 0
fi

# Configure Bitwarden server URL
echo "ðŸ“‹ Configuring Bitwarden server: $BW_SERVER"
bw config server "$BW_SERVER"

# Check if already logged in
if bw status &>/dev/null 2>&1; then
  CURRENT_SERVER=$(bw status 2>/dev/null | jq -r '.serverUrl // "unknown"' || echo "unknown")
  if [ "$CURRENT_SERVER" = "$BW_SERVER" ]; then
    echo "âœ… Bitwarden already configured and logged in"
    
    # Still check/update Keychain session
    if BW_SESSION=$(bw session 2>/dev/null); then
      security add-generic-password -a "$USER" -s "bitwarden-session" -w "$BW_SESSION" -U 2>/dev/null || \
      security add-generic-password -a "$USER" -s "bitwarden-session" -w "$BW_SESSION"
      echo "âœ… Session token updated in Keychain"
    fi
    exit 0
  fi
fi

# Prompt user to login
echo ""
echo "ðŸ”‘ Please login to Bitwarden:"
echo "   (You will be prompted for your email and password)"
echo ""
if ! bw login; then
  echo "âœ— Bitwarden login failed"
  exit 1
fi

# Extract session token and store in Keychain
echo ""
echo "ðŸ’¾ Storing session token in Keychain..."
if BW_SESSION=$(bw session); then
  security add-generic-password -a "$USER" -s "bitwarden-session" -w "$BW_SESSION" -U 2>/dev/null || \
  security add-generic-password -a "$USER" -s "bitwarden-session" -w "$BW_SESSION"
  echo "âœ… Session token stored in Keychain"
else
  echo "âœ— Failed to get session token"
  exit 1
fi

echo ""
echo "âœ… Bitwarden setup complete!"
echo "   Your secrets will be fetched from Bitwarden when fish shell starts."
